<html>
    <head>
        <title></title>

        <script src="lib/codemirror.js"></script>
        <link rel="stylesheet" href="lib/codemirror.css">
        <script src="mode/javascript/javascript.js"></script>

        <link rel="stylesheet" href="../addon/hint/show-hint.css">
        <script src="addon/hint/show-hint.js"></script>
        <script src="addon/hint/javascript-hint.js"></script>
        <script src="addon/mode/simple.js"></script>

        <script src="base.js"></script>
        <script src="syntax.js"></script>
    </head>
    <body>
<!-- Don't tabulate  -->
<pre>
Press Ctrl+Space to see available objects
Syntax:
    Object – add one Object
    Number Object – add Number of Objects
    Number * Number Object – add Rectangle of Objects
</pre>
        <div>Results/Cycle:
            <pre id="results"></pre>
        </div>
        <div id="code"></div>
    </body>
    <script>
        function showItems(editor, options){
            const cur = editor.getCursor();
            const token = editor.getTokenAt(cur);
            return {
                list: Object.keys(new Base().objects),
                from: CodeMirror.Pos(cur.line, token.start),
                to: CodeMirror.Pos(cur.line, token.end)
            }
        } 
        CodeMirror.commands.autocomplete = function(cm) {
            cm.showHint({hint: CodeMirror.hint.items});
        }
        CodeMirror.registerHelper("hint", "items", showItems);

        const cm = CodeMirror(document.getElementById("code"), {
            lineNumbers: true,
            extraKeys: {"Ctrl-Space": "autocomplete"},
            value: "5 Dup\nAlgaeDeoxydizer\nManualGenerator"
        });
        cm.on("change", onCalculate);

        function onCalculate(){
            try{
                document.getElementById("results").innerText = JSON.stringify(
                    parser.parse(cm.getValue()),
                    function(k,v){
                        if(v instanceof Elem){
                            return v.toString();
                        }else{
                            return v;
                        }
                    }, "  ");
            }catch(e){
                if(e instanceof parser.SyntaxError){
                    document.getElementById("results").innerText = `Line ${e.location.start.line} ${e.message}`;
                }else{
                    document.getElementById("results").innerText = e.message;
                }
            }
        }

        // Calculate current value
        onCalculate();
    </script>
</html>